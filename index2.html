<!DOCTYPE html>
<html>
<head>
	<title>Facilities w/ Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<!-- leaflet mapping library: https://leafletjs.com/plugins.html -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

	<!-- leaflet plugin, esri basemap: http://esri.github.io/esri-leaflet -->
    <script src="https://unpkg.com/esri-leaflet@2.3.0/dist/esri-leaflet.js" integrity="sha512-1tScwpjXwwnm6tTva0l0/ZgM3rYNbdyMj5q6RSQMbNX6EUMhYDE3pMRGZaT41zHEvLoWEK7qFEJmZDOoDMU7/Q==" crossorigin=""></script>    

	<!-- leaflet plugin, CSV overlay  -->
    <script src="lib/geocsv.js"></script>
    
    <!-- leaflet plugin, Marker Cluster: https://github.com/Leaflet/Leaflet.markercluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr" crossorigin=""/>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" integrity="sha384-RLIyj5q1b5XJTn0tqUhucRZe40nFTocRP91R/NkRJHwAe4XxnTV77FXy/vGLiec2" crossorigin=""></script>

    <!-- leaflet plugin, Search: https://github.com/stefanocudini/leaflet-search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.min.css" integrity="sha384-cn4LaTgXX4XlCvFNa4aM+sHe5s2yUXbq5135nF+P/yvvFbaCn4xdyO7Gw3ISaqDo" crossorigin=""/>
    <script src="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.src.js" integrity="sha384-okQwpsfxJf2JKLbIR9gWFBAAsCxkV3ePEz0pX9DneoTPdtJHwivL9ZCNRfw59Oof" crossorigin=""></script>
	leaflet-search

	<link rel="stylesheet" href="css/style2.css"/>

</head>
<body>

<div id="header">
	<div id="headerText">
		<h1 id="title">Alaska Facilities</h1>
		<h2 id="subtitle">A tool for locating the maintained infrastructure in Alaska's National Parks and Preserves</h2>
	</div>
	<div id="logoArea">
		<div id="organizationText">
		Alaska Region GIS<br/>
		National Park Service<br/>
		U.S. Department of the Interior<br/>
		</div>
		<div id="logo">
		<img src="images/ArrowheadNoBackground.png" height="100%" alt="National Park Service Arrowhead">
		</div>
	</div>
</div>
  
<div id="map" class="map"></div>
<script>

	var map = L.map('map').setView([62, -152], 5);

/*
	// Mapbox Streets
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(map);
*/
	// Esri World Imagery
	L.esri.basemapLayer('ImageryClarity').addTo(map);

/*
	// Park Tiles 4 (retina display problem on Safari on MacOS)
	L.tileLayer('https://api.mapbox.com/styles/v1/nps/cjt94v8pu23wh1fqug0cnviat/tiles/512/{z}/{x}/{y}?access_token=pk.eyJ1IjoibnBzIiwiYSI6IkdfeS1OY1UifQ.K8Qn5ojTw4RV1GwBlsci-Q', {
		detectRetina: true,
		attribution: "&copy; <a href='https://www.mapbox.com/about/maps/' target='_blank'>Mapbox</a> &copy; <a href='https://www.openstreetmap.org/copyright' target='_blank'>OpenStreetMap</a> contributor",
		id: 'nps.parktiles',
		maxZoom: 12,
	}).addTo(map);
*/
	// AKR GIS Facilities Map Service
	const facilitiesLayer = L.esri.dynamicMapLayer({
		url: 'https://akrgis.nps.gov/arcgis/rest/services/AKR_Apps/FMSS_web_service/MapServer',
		opacity: 1.0,
		//minZoom:8
    })
	facilitiesLayer.addTo(map);
	facilitiesLayer.bindPopup(
		function(err, featureCollection, response){
			var count = featureCollection.features.length;
    		return (count) ? count + ' features' : false;
	});

	function setupSearch() {
        var layerGroup = L.layerGroup([facilityLayer, assetLayer]);
        var controlSearch = new L.Control.Search({
            layer: layerGroup,
            propertyName: "ID",
            zoom: 18,
            textPlaceholder:"FMSS ID",
            initial: false,
            hideMarkerOnCollapse: true,
            buildTip: function(text, val) {
              var type = val.layer.feature.properties['Kind'];
              var name = val.layer.options.name;
              return '<a href="#" class="'+name+'">'+text+' <b>'+type+'</b></a>';
            }
          });
        map.addControl( controlSearch );
        map.searchBox = controlSearch;  // cache this control on the global
    }

    function find(text) {
      map.closePopup();
      map.searchBox.searchText(text);
      map.searchBox._handleKeypress({keyCode: 13});
    }

	const clusterOptions = {
		maxClusterRadius: 60,
		//showCoverageOnHover: false,
		polygonOptions: {color: '#7A904F'},
		iconCreateFunction: function (cluster) {
			var childCount = cluster.getChildCount();
			var content = '<div><span>' + childCount + '</span></div>'
			var style = 'marker-cluster marker-cluster-';
			var size = 40;
			if (childCount < 10) {
				style += 'small';
			} else if (childCount < 100) {
				style += 'medium';
				size += 10;
			} else {
				style += 'large';
				size += 20;
			}
			return new L.DivIcon({ html: content, className: style, iconSize: new L.Point(size,size) });
		},
	};

	var markers = L.markerClusterGroup(clusterOptions);
	geoCsvOpts = {
		firstLineTitles: true,
		fieldSeparator: ',',
		latitudeTitle: 'Latitude',
		longitudeTitle: 'Longitude',
		onEachFeature: function (feature, layer) {
			var popup = 
				`<div class="title">Location ${feature.properties['ID']}</div>` + 
					'<div class="content">' + 
					`<div class="description"><p>${feature.properties['Name']}</p>` + 
					'<table>';
			if (feature.properties.hasOwnProperty('DM')) {
				popup += 
						`<tr><td class="att_name">ParkID</td><td>${feature.properties['Park_Id']}</td></tr>` +
						`<tr><td class="att_name">Description</td><td>${feature.properties['Desc']}</td></tr>` +
						`<tr><td class="att_name">Value</td><td>${feature.properties['CRV']}</td></tr>` +
						`<tr><td class="att_name">Def. Maint</td><td>${feature.properties['DM']}</td></tr>` +
						`<tr><td class="att_name">Age</td><td>${feature.properties['Age']}</td></tr>` +
						`<tr><td class="att_name">Size</td><td>${feature.properties['Size']}</td></tr>` +
						`<tr><td class="att_name">Status</td><td>${feature.properties['Status']}</td></tr>`;
			} else {
				popup += `<tr><td class="att_name">ParkID</td><td>${feature.properties['Desc']}</td></tr>`
			}
			popup += `<tr><td class="att_name">Parent</td><td><a href="javascript:find('${feature.properties['Parent']}')">${feature.properties['Parent']}</a></td></tr>` +
				'</table></div>';

			layer.bindPopup(popup);
			var tooltip = feature.properties['ID'] === 'N/A' ? feature.properties['Name'] : feature.properties['ID'];
			layer.bindTooltip(tooltip,{sticky:true});
		}
	};
	var assetLayer
	var facilityLayer
	fetch('data/assets.csv')
		.then(response => response.text())
		.then(data => markers.addLayer(assetLayer = L.geoCsv(data, geoCsvOpts)));
	fetch('data/facilities.csv')
		.then(response => response.text())
		.then(data => markers.addLayer(facilityLayer = L.geoCsv(data, geoCsvOpts)));
	map.addLayer(markers);

	var photos;
	fetch("/fmss/photos.json")
		.then(response => response.json())
		.then(data => photos = data);
	
	setupSearch()
</script>
</body>
</html>
