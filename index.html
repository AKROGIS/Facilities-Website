<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>NPS Facilities (Alaska)</title>
    <link rel="stylesheet" type="text/css" href="leaflet-search/leaflet-search.src.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>

  <body>

    <div id="header">
      <div id="headerText">
        <h1 id="title">Alaska Facilities</h1>
        <h2 id="subtitle">A tool for locating the maintained infrastructure in Alaska's National Parks and Preserves</h2>
      </div>
      <div id="logoArea">
        <div id="organizationText">
          Alaska Region GIS<br/>
          National Park Service<br/>
          U.S. Department of the Interior<br/>
        </div>
        <div id="logo">
          <img src="images/ArrowheadNoBackground.png" height="100%" alt="National Park Service Arrowhead">
        </div>
      </div>
    </div>

    <div id="map"></div>

    <script>

    function setupSearch() {
        var map = NPMap.config.L;
        var layerGroup = L.layerGroup([
          NPMap.config.overlays[0].L,
          NPMap.config.overlays[1].L
        ]);
        var controlSearch = new L.Control.Search({
            layer: layerGroup,
            propertyName: "ID",
            zoom: 18,
            textPlaceholder:"FMSS ID",
            initial: false,
            hideMarkerOnCollapse: true,
            buildTip: function(text, val) {
              var type = val.layer.feature.properties['marker-symbol'];
              return '<a href="#" class="'+type+'">'+text+' <b>'+type+'</b></a>';
            }
          });
        map.addControl( controlSearch );
        map.searchBox = controlSearch;  // cache this control on the global
    }

    function find(text) {
      var map = NPMap.config.L;
      map.closePopup();
      map.searchBox.searchText(text);
      map.searchBox._handleKeypress({keyCode: 13});
    }

    function npmapReady() {
      // The last thing npmap-bootstrap.js does is add a script load to the DOM for npmap.js
      // search must be loaded after npmap.js, not just npmap-bootstrap.js, so we need to
      // wait for npmapReady() to be called before loading this script
      
      var script = document.createElement( "script" )
      script.onload = setupSearch;
      script.src = "leaflet-search/leaflet-search.src.js";
      document.body.appendChild(script);
      //setupSearch();
    }

    var NPMap = {
        center: {
            lat: 62,
            lng: -152
        },
        div: 'map',
        //plugins: [{
        //  js: '../leaflet-search/leaflet-search.src.js'
        //  // Loading css here trumps css loaded in the head
        //}],
        overlays: [
          {
            cluster: true,
            popup: {
                title: 'Asset {{ID}}',
                description: '<p>{{Name}}</p>' +
                '<table>' +
                    '<tr><td class="att_name">Description</td><td>{{Desc}}</td></tr>' +
                    '<tr><td class="att_name">Parent</td><td><a href="javascript:find(\'{{Parent}}\')">' + 
                    '{{Parent}}</a></td></tr>' +
                    '</table>',
                media:[{
                    type:"fmss",
                    id:"Photo_Id"
                }]
            },
            styles: {
              point: {
                  'marker-symbol': 'triangle'
              }
            },
            tooltip: '{{ID}}',
            type: 'csv',
            url: 'data/assets.csv'
          }
          ,{
            cluster: true,
            popup: {
                title: 'Location {{ID}}',
                description: '<p>{{Name}}</p>' +
                '<table>' +
                    '<tr><td class="att_name">ParkID</td><td>{{Park_Id}}</td></tr>' +
                    '<tr><td class="att_name">Description</td><td>{{Desc}}</td></tr>' +
                    '<tr><td class="att_name">Value</td><td>{{CRV}}</td></tr>' +
                    '<tr><td class="att_name">Def. Maint</td><td>{{DM}}</td></tr>' +
                    '<tr><td class="att_name">Age</td><td>{{Age}}</td></tr>' +
                    '<tr><td class="att_name">Status</td><td>{{Status}}</td></tr>' +
                    '<tr><td class="att_name">Parent</td><td><a href="javascript:find(\'{{Parent}}\')">' + 
                    '{{Parent}}</a></td></tr>' +
                    '</table>',
                media:[{
                    type:"fmss",
                    id:"Photo_Id"
                }]
            },
            styles: {
              point: {
                  'marker-symbol': 'square'
              }
            },
            tooltip: '{{ID}}',
            type: 'csv',
            url: 'data/facilities.csv'
          }
          ,{
            type:'arcgisserver',
            opacity: 1.0,
            tiled: false,
            minZoom:15,
            url: 'https://akrgis.nps.gov/arcgis/rest/services/AKR_Apps/FMSS_web_service/MapServer'
          }
        ,{
            type: 'arcgisserver',
            opacity: 0.8,
            tiled: true,
            url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer',
            minZoom:15,
          }
        ],
        zoom: 5,
        maxZoom: 20
    };

      var photos;
      fetch("/fmss/photos.json")
        .then(response => response.json())
        .then(data => photos = data);

    </script>
    <script src="npmap/npmap-bootstrap.js"></script>
  </body>
</html>
